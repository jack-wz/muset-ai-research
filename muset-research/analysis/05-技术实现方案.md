# Muset.ai 技术实现方案

## 一、总体技术栈

### 前端（ag-ui）
```
Next.js 14 + React 18
├── TypeScript 5
├── App Router（Server Components + Client Components）
├── Tailwind CSS + Emotion（局部定制样式）
├── Radix UI + Framer Motion（交互与动画）
├── TipTap 2（富文本编辑器）
├── React Query + Zustand（数据/状态管理）
├── UploadThing + Next API Route（文件上传）
└── i18next + next-intl（多语言支持）
```

### 后端（DeepAgent 服务）
```
Python 3.10+
├── FastAPI（REST + WebSocket）
├── LangChain + LangGraph + langchain-deepagents
├── langchain-mcp-adapters（MCP 工具）
├── Claude SDK / OpenAI SDK（模型调用）
├── SQLModel + PostgreSQL（业务数据）
├── Redis（会话、流式事件）
├── MinIO / OSS（上下文文件）
└── Celery / Arq（异步任务与子智能体执行）
```

### 基础设施
- Docker Compose（本地开发 `frontend` + `backend` + `postgres` + `redis`）
- Terraform + Helm（生产部署，可扩展到 K8s）
- Vault / Doppler（API Key 加密管理）

## 二、Monorepo 结构

```
ai-writing-assistant/
├── frontend/                      # Next.js 14 项目
│   ├── app/
│   │   ├── layout.tsx
│   │   ├── page.tsx
│   │   ├── (workspace)/
│   │   │   ├── [workspaceId]/
│   │   │   │   ├── layout.tsx
│   │   │   │   └── [pageId]/page.tsx
│   │   └── (auth)/callback/route.ts
│   ├── components/
│   │   ├── editor/
│   │   ├── chat/
│   │   ├── settings/
│   │   └── inspires/
│   ├── hooks/                     # useWorkspace、useChatStreaming
│   ├── lib/
│   │   ├── api-client.ts          # fetch wrapper + streaming
│   │   └── tiptap-extensions.ts
│   ├── store/                     # Zustand slices
│   ├── styles/
│   ├── public/
│   └── next.config.mjs
├── backend/                       # FastAPI + LangChain
│   ├── app/
│   │   ├── main.py
│   │   ├── api/
│   │   │   ├── v1/
│   │   │   │   ├── auth.py
│   │   │   │   ├── workspaces.py
│   │   │   │   ├── plans.py
│   │   │   │   ├── chat.py
│   │   │   │   ├── files.py
│   │   │   │   ├── skills.py
│   │   │   │   └── configs.py
│   │   ├── agents/
│   │   │   ├── planner.py
│   │   │   ├── filesystem.py
│   │   │   ├── memory.py
│   │   │   ├── subagent_manager.py
│   │   │   └── runtime.py
│   │   ├── services/
│   │   │   ├── mcp_adapter.py
│   │   │   ├── skill_loader.py
│   │   │   ├── model_registry.py
│   │   │   └── config_snapshot.py
│   │   ├── schemas/
│   │   ├── repositories/
│   │   └── tests/
│   ├── alembic/
│   ├── pyproject.toml
│   └── poetry.lock
├── docs/
├── docker-compose.yml
└── .env.example
```

## 三、后端核心模块设计

### 1. 任务规划器（TaskPlanner）
```python
class TaskPlanner:
    def __init__(self, llm: BaseChatModel, fs: FileSystemManager):
        self.llm = llm
        self.fs = fs

    async def analyze_goal(self, goal: str, context: PlannerContext) -> WritingPlan:
        prompt = planner_prompt.format(goal=goal, context=context.serialize())
        response = await self.llm.ainvoke(prompt)
        plan = WritingPlan.parse_raw(response.content)
        return self.fs.persist_plan(plan)

    async def create_todos(self, plan: WritingPlan) -> List[TodoTask]:
        tasks = [self._build_task(item) for item in plan.tasks]
        await self.fs.write_todos(plan.id, tasks)
        return tasks
```
- 依赖 LangGraph 管理计划执行顺序
- 支持 DAG 校验与动态更新（需求 1）

### 2. 文件系统管理器（FileSystemManager）
```python
class FileSystemManager:
    base_dir = Path("/data/workspaces")

    def write_file(self, workspace_id: str, rel_path: str, content: str) -> FileHandle:
        target = self.base_dir / workspace_id / rel_path
        target.parent.mkdir(parents=True, exist_ok=True)
        target.write_text(content, encoding="utf-8")
        return self._index_file(target)

    def create_version(self, file_id: str) -> str:
        snapshot = self._snapshot_path(file_id)
        shutil.copyfile(self.resolve(file_id), snapshot)
        return snapshot
```
- 集成 `ripgrep` 搜索、版本快照和 OSS 同步，满足需求 2、18

### 3. 记忆管理器（MemoryManager）
```python
class MemoryManager:
    def __init__(self, vector: VectorStore, repo: MemoryRepository):
        self.vector = vector
        self.repo = repo

    async def store_style_profile(self, workspace_id: str, profile: StyleProfile):
        memory = Memory(workspace_id=workspace_id, type="style", payload=profile)
        await self.repo.save(memory)
        await self.vector.add_texts([profile.render_prompt()], ids=[memory.id])
```
- 提供 `load_memories(query, top_k)` 接口给 LLM 检索（需求 4、13）

### 4. 子智能体管理（SubAgentManager）
```python
class SubAgentManager:
    async def spawn(self, agent_type: AgentType, context: SubAgentContext) -> AgentRun:
        agent = self._build_agent(agent_type, context)
        return await agent.execute()

    def _build_agent(self, agent_type: AgentType, context: SubAgentContext):
        if agent_type == AgentType.RESEARCH:
            return ResearchAgent(toolset=self.mcp.search_tools(context.language))
        if agent_type == AgentType.TRANSLATION:
            return TranslationAgent(model=self.models.get_multilingual())
        ...
```
- 依赖 `langgraph` 子图隔离上下文，确保需求 3

### 5. MCP 适配与技能加载
- `MCPAdapter.discover_servers()` 通过配置表扫描 + health check
- `connect_server()` 建立 WebSocket/HTTP 连接并缓存工具元数据
- `SkillLoader.load_skill()` 解析 `SKILL.md`、校验资源、注入系统提示
- 工具统一封装为 LangChain `Tool`，供 `DeepAgent` runtime 调度（需求 5/6/12）

### 6. 配置管理与导入导出
- `ModelRegistry`：统一管理模型配置、密钥引用、动态切换
- `ConfigSnapshotService`：将模型、MCP、技能、偏好序列化为 JSON，支持选择性导入
- API 端点：
  - `POST /configs/export` → 生成脱敏 JSON
  - `POST /configs/import` → Dry-run + 应用
  - `GET /configs/models|mcp|skills` → 前端设置页使用

## 四、前端关键实现

### 1. 数据获取与状态
- `React Query` 负责服务器数据缓存，`Zustand` 维护实时编辑状态（编辑器内容、AI 工具栏）
- WebSocket（Next.js Route Handler `/api/stream`）订阅聊天流式和任务进度
- 多语言：`next-intl` + `app/[locale]/layout.tsx` 切换

### 2. 富文本编辑器
```tsx
const Editor = ({ pageId }: { pageId: string }) => {
  const { data: page } = useQuery(['page', pageId], fetchPage);
  const mutation = useAutosaveMutation(pageId);

  const editor = useEditor({
    extensions: baseExtensions.concat([
      Collaboration.configure({ document: yDoc }),
      Highlight,
      Placeholder.configure({ placeholder: t('editor.placeholder') }),
    ]),
    content: page?.tiptapContent,
    onUpdate: ({ editor }) => mutation.mutate(editor.getJSON()),
  });

  return <EditorContent editor={editor} />;
};
```
- 选中文本出现浮动 AI 工具栏，调用 `/api/ai/tools` 端点执行（需求 7、11）

### 3. 聊天与流式响应
```tsx
const sendMessage = async (payload: SendMessageDto) => {
  const res = await fetch('/api/chat/stream', {
    method: 'POST',
    body: JSON.stringify(payload),
  });
  for await (const chunk of streamBody(res.body)) {
    appendChunk(chunk); // SSE 解析
  }
};
```
- 引入 AbortController 支持“停止生成”
- 消息引用文件/记忆时显示可点击 chips（需求 8、16）

### 4. 设置与配置 UI
- Next.js Server Action 获取模型/MCP/技能列表
- Radix Dialog + Stepper 组件实现导入导出向导
- `useForm` + Zod 校验 API Key、Endpoint，提交前先 `POST /configs/test`

## 五、任务与文件导航实现
- 左侧导航：`/app/(workspace)/[workspaceId]/layout.tsx` 加载项目、文件树
- 文件树通过 `SWR subscription` 监听后端 `files.updated` WebSocket 事件，实现实时刷新（需求 9/10/24）
- 版本历史：调用 `GET /files/{id}/versions`，使用 Diff Viewer 组件渲染（需求 18）

## 六、AI 工具与提示系统
- 提示建议：`GET /inspirations?category=...`，结果缓存 5 分钟，支持社区样本
- 工具栏：根据选择文本长度与已启用技能动态显示按钮，调用 `POST /ai/tools/{tool}`，并在响应中附带 diff 文件 ID

## 七、测试与质量策略

### 1. 后端
- `pytest` + `pytest-asyncio`
- 属性测试：
  - 任务规划完整性（Hypothesis）→ DAG 无环
  - 文件系统往返、上下文大小（大内容外部化）
  - 子智能体上下文隔离（对比上下文 diff）
  - 流式响应完整性（重组 chunk）
- 集成测试：`langgraph` 运行全链路，模拟写作会话

### 2. 前端
- `Vitest` + `Testing Library` 测组件
- `Playwright` E2E：认证、编辑、聊天、设置
- 可访问性测试：`@axe-core/playwright`

### 3. 性能与监控
- 前端：Next.js `dynamic()` 懒加载大组件；TipTap 输入节流；图片使用 `next/image`
- 后端：LangChain 调用缓存、Redis 结果缓存、流式响应在 2 秒内启动
- 监控：OpenTelemetry + Tempo + Loki；Sentry 捕获前后端错误

## 八、部署与安全
- Docker 镜像：`frontend.Dockerfile`（Next build + standalone）与 `backend.Dockerfile`
- CI：GitHub Actions
  - Lint/Test
  - Docker Build & Push
  - Deploy（ArgoCD 或 Vercel + Fly.io）
- 安全：
  - API Key 存 Vault，前端仅存密钥引用
  - 技能包上传后在隔离容器执行，限制 CPU/内存/网络
  - 所有导出文件加密并设定有效期

该方案确保 `.kiro` 需求中的 DeepAgent 核心、MCP/技能/模型配置、多语言、写作风格、流式交互等能力均有明确落地路径，且前后端协同结构清晰可扩展。
