# Muset.ai 数据模型设计

## 一、核心数据模型

### 1. User（用户）
```typescript
interface User {
  id: string;                    // 用户ID
  email: string;                 // 邮箱
  name: string;                  // 用户名
  avatar: string;                // 头像URL
  provider: 'google';            // 登录方式
  createdAt: Date;               // 创建时间
  updatedAt: Date;               // 更新时间
  
  subscription: SubscriptionInfo;
  settings: UserSettings;
  memories: string[];            // 关联记忆ID
  workspaces: string[];          // 可访问工作区
}

interface SubscriptionInfo {
  plan: 'free' | 'pro';
  aiChatsLeft: number;
  aiChatsTotal: number;
  expiresAt?: Date;
  perks: {
    workspaceLimit: number;
    maxUploadSizeMB: number;
    realtimeStreaming: boolean;
  };
}

interface UserSettings {
  language: string;              // UI语言
  theme: 'light' | 'dark' | 'system';
  tonePreference?: string;       // 默认写作语气
  notificationChannels: {
    email: boolean;
    inApp: boolean;
    desktop: boolean;
  };
}
```

### 2. Workspace（工作区）
```typescript
interface Workspace {
  id: string;
  name: string;
  ownerId: string;
  description?: string;
  icon?: string;
  createdAt: Date;
  updatedAt: Date;
  lastAccessedAt: Date;
  
  members: WorkspaceMember[];
  activeProjectId?: string;
  stats: WorkspaceStats;
}

interface WorkspaceMember {
  userId: string;
  role: 'owner' | 'editor' | 'viewer';
  joinedAt: Date;
  lastActiveAt: Date;
}

interface WorkspaceStats {
  pageCount: number;
  totalWords: number;
  draftCount: number;
  activePlans: number;
}
```

### 3. Page（页面/文稿）
```typescript
interface Page {
  id: string;
  workspaceId: string;
  title: string;
  slug?: string;
  summary?: string;
  coverImage?: string;
  status: 'draft' | 'review' | 'published';
  tags: string[];
  outline: OutlineBlock[];
  linkedPlanId?: string;
  linkedFiles: string[];
  linkedMemories: string[];
  tiptapContent: JSONContent;    // TipTap JSON
  wordCount: number;
  aiEditedSections: AIEditedSection[];
  createdAt: Date;
  updatedAt: Date;
  lastEditedBy: string;
}

interface OutlineBlock {
  id: string;
  title: string;
  level: 1 | 2 | 3;
  status: 'todo' | 'in_progress' | 'done';
}

interface AIEditedSection {
  blockId: string;
  tool: 'continue' | 'summarize' | 'polish' | 'translate' | 'expand';
  diffLink: string;              // 指向版本 diff
  appliedAt: Date;
}
```

### 4. WritingPlan & TodoTask（写作计划与任务）
```typescript
interface WritingPlan {
  id: string;
  workspaceId: string;
  pageId?: string;
  goal: string;
  sourcePrompt: string;
  status: 'pending' | 'active' | 'completed' | 'archived';
  currentTaskId?: string;
  tasks: string[];
  createdAt: Date;
  updatedAt: Date;
}

interface TodoTask {
  id: string;
  planId: string;
  title: string;
  description: string;
  status: 'pending' | 'in_progress' | 'blocked' | 'completed';
  stepType: 'outline' | 'draft' | 'research' | 'edit' | 'publish';
  dependencies: string[];
  outputs: ContextReference[];
  assignedAgentId?: string;
  startedAt?: Date;
  completedAt?: Date;
  priority: 'low' | 'medium' | 'high';
}

interface ContextReference {
  fileId?: string;
  pageId?: string;
  memoryId?: string;
  label: string;
}
```

### 5. ContextFile & FileVersion（上下文文件）
```typescript
interface ContextFile {
  id: string;
  workspaceId: string;
  category: 'draft' | 'reference' | 'upload' | 'memory' | 'todo' | 'system';
  name: string;
  path: string;
  mimeType: string;
  size: number;
  checksum: string;
  versions: FileVersion[];
  relatedPages: string[];
  createdAt: Date;
  updatedAt: Date;
}

interface FileVersion {
  id: string;
  fileId: string;
  snapshotPath: string;
  createdAt: Date;
  createdBy: string;             // Agent ID or user
  diffSummary?: string;
}

interface FileSearchIndex {
  fileId: string;
  embeddingId: string;
  tokenCount: number;
  lastIndexedAt: Date;
}
```

### 6. Memory（长期记忆）
```typescript
interface Memory {
  id: string;
  workspaceId: string;
  type: 'style' | 'glossary' | 'preference' | 'knowledge';
  title: string;
  payload: MemoryPayload;
  embeddingId?: string;
  tags: string[];
  importanceScore: number;       // 用于检索排序
  createdAt: Date;
  updatedAt: Date;
}

type MemoryPayload = StyleProfile | GlossaryEntry | KnowledgeNote | Preference;

interface StyleProfile {
  samples: string[];
  toneDescriptors: string[];
  pacing: 'slow' | 'balanced' | 'fast';
  sentenceLength: 'short' | 'medium' | 'long';
  doAndDont: {
    prefer: string[];
    avoid: string[];
  };
}

interface GlossaryEntry {
  term: string;
  definition: string;
  usageExamples: string[];
  locale: string;
}

interface KnowledgeNote {
  topic: string;
  summary: string;
  citations: string[];
}

interface Preference {
  key: string;
  value: string | number | boolean;
  context: string;
}
```

### 7. ChatSession & ChatMessage（聊天与上下文）
```typescript
interface ChatSession {
  id: string;
  workspaceId: string;
  pageId?: string;
  title: string;
  mode: 'chat' | 'agent-run';
  language: string;
  systemPrompt?: string;
  activeModelId: string;
  activeSkills: string[];
  createdAt: Date;
  updatedAt: Date;
  messageIds: string[];
}

interface ChatMessage {
  id: string;
  sessionId: string;
  role: 'user' | 'assistant' | 'system' | 'tool';
  content: string;
  streamingState?: StreamingState;
  attachments: Attachment[];
  referencedFiles: string[];
  referencedMemories: string[];
  metadata: {
    planId?: string;
    taskId?: string;
    skillId?: string;
    mcpToolCallId?: string;
  };
  createdAt: Date;
}

interface StreamingState {
  isStreaming: boolean;
  lastChunkAt?: Date;
  cancelToken?: string;
}

interface Attachment {
  id: string;
  fileId: string;
  type: 'document' | 'image' | 'audio' | 'video';
  previewUrl?: string;
}
```

### 8. PromptSuggestion & Inspiration（提示建议）
```typescript
interface PromptSuggestion {
  id: string;
  category: 'question' | 'theme' | 'angle' | 'community-sample';
  text: string;
  icon?: string;
  tags: string[];
  locale: string;
  requiredSkills?: string[];
  createdAt: Date;
  updatedAt: Date;
}

interface InspirationBoard {
  id: string;
  workspaceId: string;
  title: string;
  relatedPageIds: string[];
  suggestions: string[];
  communitySampleIds: string[];
}
```

### 9. SkillPackage（技能包）
```typescript
interface SkillPackage {
  id: string;
  name: string;
  version: string;
  provider: 'claude' | 'custom';
  manifestPath: string;          // SKILL.md
  instructions: string;
  defaultEnabled: boolean;
  requiredResources: SkillResource[];
  exposedTools: SkillTool[];
  sandboxPolicy: SandboxPolicy;
  createdAt: Date;
  updatedAt: Date;
}

interface SkillResource {
  id: string;
  type: 'template' | 'script' | 'dictionary' | 'dataset';
  path: string;
  checksum: string;
}

interface SkillTool {
  name: string;
  description: string;
  inputSchema: JsonSchema;
  outputSchema: JsonSchema;
}

interface SandboxPolicy {
  allowNetwork: boolean;
  allowedHosts?: string[];
  memoryLimitMB: number;
  timeoutMs: number;
}
```

### 10. MCPServerConfig（MCP 服务器配置）
```typescript
interface MCPServerConfig {
  id: string;
  name: string;
  endpoint: string;
  protocol: 'http' | 'ws';
  authType: 'none' | 'api_key' | 'oauth';
  authSecretId?: string;         // 指向加密存储
  status: 'disconnected' | 'connected' | 'error';
  lastConnectedAt?: Date;
  tools: MCPToolConfig[];
  retryPolicy: RetryPolicy;
}

interface MCPToolConfig {
  name: string;
  description: string;
  inputSchema: JsonSchema;
  outputSchema: JsonSchema;
  mappedLangChainTool: string;
  enabled: boolean;
}

interface RetryPolicy {
  maxAttempts: number;
  backoffMs: number;
}
```

### 11. ModelConfig（模型配置）
```typescript
interface ModelConfig {
  id: string;
  provider: 'anthropic' | 'openai' | 'azure' | 'local';
  label: string;
  modelName: string;
  apiKeySecretId: string;
  baseUrl?: string;
  default: boolean;
  capabilities: {
    streaming: boolean;
    vision: boolean;
    toolUse: boolean;
    multilingual: boolean;
  };
  guardrails?: GuardrailConfig;
  createdAt: Date;
  updatedAt: Date;
}

interface GuardrailConfig {
  maxTokens: number;
  temperature: number;
  topP: number;
  stopSequences?: string[];
}
```

### 12. UploadAsset（上传资源）
```typescript
interface UploadAsset {
  id: string;
  workspaceId: string;
  uploaderId: string;
  fileId: string;
  originalName: string;
  fileType: 'document' | 'image' | 'audio' | 'video' | 'spreadsheet' | 'presentation';
  status: 'processing' | 'ready' | 'failed';
  processingMetadata?: {
    extractedTextFileId?: string;
    thumbnailFileId?: string;
    ocrStatus?: 'pending' | 'completed';
  };
  createdAt: Date;
  updatedAt: Date;
}
```

## 二、DeepAgent 运行态模型

### 1. AgentRun（智能体运行记录）
```typescript
interface AgentRun {
  id: string;
  sessionId: string;
  planId?: string;
  trigger: 'user_request' | 'scheduled' | 'system';
  status: 'pending' | 'running' | 'paused' | 'completed' | 'failed';
  currentStepId?: string;
  steps: AgentStep[];
  relatedSubAgents: string[];
  createdAt: Date;
  updatedAt: Date;
  errorMessage?: string;
}

interface AgentStep {
  id: string;
  runId: string;
  type: 'plan' | 'tool' | 'file_op' | 'skill_activation' | 'mcp_call';
  input: JsonValue;
  output?: JsonValue;
  startedAt: Date;
  finishedAt?: Date;
}
```

### 2. SubAgentContext（子智能体上下文）
```typescript
interface SubAgentContext {
  id: string;
  parentRunId: string;
  agentType: 'research' | 'translation' | 'editing' | 'fact_check';
  scopedFiles: string[];
  scopedMemories: string[];
  tempDirectory: string;
  instructions: string;
  resultFileId?: string;
  createdAt: Date;
  completedAt?: Date;
}
```

## 三、配置与安全模型

### 1. ConfigSnapshot（配置快照）
```typescript
interface ConfigSnapshot {
  id: string;
  workspaceId?: string;
  createdAt: Date;
  createdBy: string;
  payload: {
    models: ModelConfig[];
    mcpServers: MCPServerConfig[];
    skills: SkillPackage[];
    preferences: Preference[];
  };
  checksum: string;
  encryptedFields: string[];
}
```

### 2. AuditLog（审计日志）
```typescript
interface AuditLog {
  id: string;
  actorId: string;
  workspaceId?: string;
  entityType: string;
  entityId: string;
  action: 'create' | 'update' | 'delete' | 'import' | 'export' | 'activate' | 'deactivate';
  payload: JsonValue;
  createdAt: Date;
  ipAddress?: string;
}
```

## 四、数据关系概览

- `User` 与 `Workspace` 是多对多，工作区成员以 `WorkspaceMember` 记录角色与活跃度。
- `Workspace` 下包含 `Page`、`WritingPlan`、`ContextFile`、`Memory`、`ChatSession` 等实体，通过 `workspaceId` 统一归档，满足需求 2/4/9/10。
- `WritingPlan` 与 `TodoTask` 一对多，任务输出通过 `ContextReference` 关联文件/记忆/页面，支撑任务规划和动态调整（需求 1）。
- `ContextFile` 与 `FileVersion` 一对多，同时 `FileSearchIndex` 提供向量检索，满足上下文管理和版本历史（需求 2、18）。
- `Memory` 与 `Page`、`ChatMessage` 通过引用 ID 互联，确保风格和术语能够被写作与对话复用（需求 4、13）。
- `ChatSession` 与 `AgentRun` 同步，消息中 `metadata` 标记对应计划、技能、MCP 工具调用，支撑对话与流式显示（需求 8、16）。
- `SkillPackage`、`MCPServerConfig`、`ModelConfig` 属于配置域，可通过 `ConfigSnapshot` 导出导入，满足需求 20-23。
- `UploadAsset` 与 `ContextFile` 映射上传链路，确保文件上传/处理与上下文引用一致（需求 15）。

## 五、字段设计注意事项

1. **时间戳统一 UTC**：所有 `Date` 字段存 UTC，前端按用户时区渲染，保证跨区域协作一致。
2. **JSONContent 兼容 TipTap**：`Page.tiptapContent` 直接存 TipTap JSON，服务端用于 diff、高亮，避免重复解析。
3. **可扩展枚举**：如 `stepType`、`status` 等枚举以字符串存储，便于未来扩展新类型。
4. **引用完整性**：`linkedPlanId`、`linkedFiles`、`linkedMemories` 等引用在变更时需保持同步，建议使用数据库级外键或事件驱动校验。
5. **敏感配置隔离**：`apiKeySecretId` 等字段仅存密钥引用，实际值写入密钥管理服务，保证配置导出时可脱敏。
6. **向量索引解耦**：`Memory.embeddingId`、`FileSearchIndex.embeddingId` 不直接绑定具体数据库实现，便于 Pinecone/FAISS 替换。

该数据模型覆盖 `.kiro` 需求文档中的任务规划、文件系统、记忆管理、MCP/技能集成、配置导入导出、多语言与风格定制等关键能力，为后续 DeepAgent 与 ag-ui 的联调提供稳定基础。
