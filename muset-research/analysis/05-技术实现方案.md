# Muset.ai 技术实现方案

## 一、技术栈分析

### 前端技术栈
```
React 18+ (核心框架)
├── TypeScript (类型系统)
├── Emotion (CSS-in-JS)
├── Radix UI (无样式组件库)
├── TipTap (富文本编辑器)
├── Slick Carousel (轮播组件)
├── React Joyride (用户引导)
└── React Router (路由管理)
```

### 状态管理
- React Context API
- 或 Zustand/Redux (待确认)

### 构建工具
- Vite 或 Webpack
- TypeScript Compiler
- PostCSS

### 代码质量
- ESLint
- Prettier
- Husky (Git Hooks)

## 二、项目结构设计

```
muset-clone/
├── public/
│   ├── favicon.ico
│   └── assets/
├── src/
│   ├── components/          # 通用组件
│   │   ├── ui/             # UI基础组件
│   │   │   ├── Button/
│   │   │   ├── Input/
│   │   │   ├── Card/
│   │   │   ├── Modal/
│   │   │   └── ...
│   │   ├── layout/         # 布局组件
│   │   │   ├── Header/
│   │   │   ├── Sidebar/
│   │   │   └── MainLayout/
│   │   └── features/       # 功能组件
│   │       ├── Editor/
│   │       ├── Chat/
│   │       └── Community/
│   ├── pages/              # 页面组件
│   │   ├── Home/
│   │   ├── Workspace/
│   │   └── Auth/
│   ├── hooks/              # 自定义Hooks
│   │   ├── useAuth.ts
│   │   ├── useWorkspace.ts
│   │   └── useChat.ts
│   ├── services/           # API服务
│   │   ├── api.ts
│   │   ├── auth.ts
│   │   ├── workspace.ts
│   │   └── chat.ts
│   ├── store/              # 状态管理
│   │   ├── auth/
│   │   ├── workspace/
│   │   └── chat/
│   ├── utils/              # 工具函数
│   │   ├── format.ts
│   │   ├── validation.ts
│   │   └── helpers.ts
│   ├── types/              # TypeScript类型
│   │   ├── models.ts
│   │   └── api.ts
│   ├── styles/             # 全局样式
│   │   ├── theme.ts
│   │   ├── global.ts
│   │   └── variables.ts
│   ├── config/             # 配置文件
│   │   ├── constants.ts
│   │   └── env.ts
│   ├── App.tsx
│   └── main.tsx
├── package.json
├── tsconfig.json
├── vite.config.ts
└── README.md
```

## 三、核心功能实现

### 1. 认证系统

**Google OAuth实现**:
```typescript
// services/auth.ts
export const googleLogin = async () => {
  const clientId = process.env.GOOGLE_CLIENT_ID;
  const redirectUri = `${window.location.origin}/oauth/callback`;
  
  const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
    `client_id=${clientId}&` +
    `redirect_uri=${redirectUri}&` +
    `response_type=code&` +
    `scope=profile email&` +
    `state=${generateState()}`;
  
  window.location.href = authUrl;
};

export const handleCallback = async (code: string) => {
  const response = await api.post('/oauth/callback', { code });
  const { token, user } = response.data;
  
  localStorage.setItem('token', token);
  return user;
};
```

### 2. 工作区管理

**数据模型**:
```typescript
// types/models.ts
interface Workspace {
  id: string;
  name: string;
  ownerId: string;
  createdAt: string;
  updatedAt: string;
  pages: Page[];
}

interface Page {
  id: string;
  workspaceId: string;
  title: string;
  content: any; // TipTap JSON
  createdAt: string;
  updatedAt: string;
}
```

**API服务**:
```typescript
// services/workspace.ts
export const workspaceService = {
  list: () => api.get('/workspaces'),
  get: (id: string) => api.get(`/workspaces/${id}`),
  create: (data: CreateWorkspaceDto) => 
    api.post('/workspaces', data),
  update: (id: string, data: UpdateWorkspaceDto) => 
    api.patch(`/workspaces/${id}`, data),
  delete: (id: string) => api.delete(`/workspaces/${id}`),
};
```

### 3. 富文本编辑器

**TipTap配置**:
```typescript
// components/features/Editor/Editor.tsx
import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Placeholder from '@tiptap/extension-placeholder';
import Link from '@tiptap/extension-link';

const Editor = ({ content, onChange }) => {
  const editor = useEditor({
    extensions: [
      StarterKit,
      Placeholder.configure({
        placeholder: 'Drop an idea, let\'s shape...',
      }),
      Link.configure({
        openOnClick: false,
      }),
    ],
    content,
    onUpdate: ({ editor }) => {
      onChange(editor.getJSON());
    },
  });

  return <EditorContent editor={editor} />;
};
```

### 4. AI聊天功能

**流式响应处理**:
```typescript
// services/chat.ts
export const sendMessage = async (
  message: string,
  onChunk: (chunk: string) => void
) => {
  const response = await fetch('/api/chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${getToken()}`,
    },
    body: JSON.stringify({ message }),
  });

  const reader = response.body.getReader();
  const decoder = new TextDecoder();

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    const chunk = decoder.decode(value);
    onChunk(chunk);
  }
};
```

**聊天组件**:
```typescript
// components/features/Chat/Chat.tsx
const Chat = () => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const handleSend = async () => {
    if (!input.trim()) return;
    
    const userMessage = { role: 'user', content: input };
    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setIsLoading(true);

    let aiResponse = '';
    await sendMessage(input, (chunk) => {
      aiResponse += chunk;
      setMessages(prev => [
        ...prev.slice(0, -1),
        { role: 'assistant', content: aiResponse }
      ]);
    });

    setIsLoading(false);
  };

  return (
    <div>
      <MessageList messages={messages} />
      <MessageInput 
        value={input}
        onChange={setInput}
        onSend={handleSend}
        disabled={isLoading}
      />
    </div>
  );
};
```

### 5. 文件上传

**上传组件**:
```typescript
// components/ui/FileUpload/FileUpload.tsx
const FileUpload = ({ onUpload, accept, multiple }) => {
  const handleChange = async (e: ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    
    for (const file of files) {
      // 验证文件
      if (!validateFile(file, accept)) {
        toast.error('Invalid file type');
        continue;
      }

      // 上传到OSS
      const url = await uploadToOSS(file);
      onUpload({ file, url });
    }
  };

  return (
    <input
      type="file"
      accept={accept}
      multiple={multiple}
      onChange={handleChange}
      style={{ display: 'none' }}
    />
  );
};
```

**OSS上传**:
```typescript
// services/upload.ts
export const uploadToOSS = async (file: File) => {
  // 1. 获取上传凭证
  const { uploadUrl, key } = await api.post('/upload/token', {
    filename: file.name,
    contentType: file.type,
  });

  // 2. 上传到OSS
  await fetch(uploadUrl, {
    method: 'PUT',
    body: file,
    headers: {
      'Content-Type': file.type,
    },
  });

  // 3. 返回文件URL
  return `${CDN_BASE_URL}/${key}`;
};
```

## 四、状态管理方案

### Context + Hooks方案
```typescript
// store/auth/AuthContext.tsx
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
}

const AuthContext = createContext<AuthState | null>(null);

export const AuthProvider = ({ children }) => {
  const [state, setState] = useState<AuthState>({
    user: null,
    token: null,
    isAuthenticated: false,
  });

  const login = async (token: string) => {
    const user = await fetchUser(token);
    setState({ user, token, isAuthenticated: true });
  };

  const logout = () => {
    setState({ user: null, token: null, isAuthenticated: false });
    localStorage.removeItem('token');
  };

  return (
    <AuthContext.Provider value={{ ...state, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within AuthProvider');
  return context;
};
```

## 五、路由设计

```typescript
// App.tsx
const router = createBrowserRouter([
  {
    path: '/',
    element: <RootLayout />,
    children: [
      {
        index: true,
        element: <Navigate to="/workspace" replace />,
      },
      {
        path: 'workspace',
        element: <WorkspaceLayout />,
        children: [
          {
            path: ':workspaceId',
            children: [
              {
                path: 'home',
                element: <HomePage />,
              },
              {
                path: ':pageId',
                element: <PageView />,
              },
            ],
          },
        ],
      },
      {
        path: 'oauth/callback',
        element: <OAuthCallback />,
      },
    ],
  },
]);
```

## 六、性能优化策略

### 1. 代码分割
```typescript
// 路由级别懒加载
const HomePage = lazy(() => import('./pages/Home'));
const PageView = lazy(() => import('./pages/PageView'));

// 组件级别懒加载
const Editor = lazy(() => import('./components/features/Editor'));
```

### 2. 图片优化
```typescript
// 使用WebP格式
const ImageWithFallback = ({ src, alt }) => {
  return (
    <picture>
      <source srcSet={`${src}.webp`} type="image/webp" />
      <img src={src} alt={alt} loading="lazy" />
    </picture>
  );
};
```

### 3. 虚拟滚动
```typescript
// 使用react-window处理长列表
import { FixedSizeList } from 'react-window';

const CommunityList = ({ items }) => {
  return (
    <FixedSizeList
      height={600}
      itemCount={items.length}
      itemSize={200}
      width="100%"
    >
      {({ index, style }) => (
        <div style={style}>
          <CommunityCard item={items[index]} />
        </div>
      )}
    </FixedSizeList>
  );
};
```

### 4. 防抖节流
```typescript
// hooks/useDebounce.ts
export const useDebounce = <T,>(value: T, delay: number): T => {
  const [debouncedValue, setDebouncedValue] = useState(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => clearTimeout(handler);
  }, [value, delay]);

  return debouncedValue;
};
```

## 七、测试策略

### 单元测试
```typescript
// components/ui/Button/Button.test.tsx
import { render, fireEvent } from '@testing-library/react';
import { Button } from './Button';

describe('Button', () => {
  it('renders correctly', () => {
    const { getByText } = render(<Button>Click me</Button>);
    expect(getByText('Click me')).toBeInTheDocument();
  });

  it('handles click events', () => {
    const handleClick = jest.fn();
    const { getByText } = render(
      <Button onClick={handleClick}>Click me</Button>
    );
    
    fireEvent.click(getByText('Click me'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });
});
```

### E2E测试
```typescript
// e2e/auth.spec.ts
import { test, expect } from '@playwright/test';

test('user can login with Google', async ({ page }) => {
  await page.goto('/');
  await page.click('text=Login with Google');
  
  // Mock Google OAuth
  await page.route('**/oauth/callback', route => {
    route.fulfill({
      status: 200,
      body: JSON.stringify({ token: 'mock-token' }),
    });
  });

  await expect(page).toHaveURL(/\/workspace/);
});
```

## 八、部署方案

### 前端部署
- Vercel / Netlify
- CDN加速
- 自动化CI/CD

### 环境变量
```env
VITE_API_BASE_URL=https://api.muset.ai
VITE_GOOGLE_CLIENT_ID=xxx
VITE_OSS_BUCKET=muset-files
VITE_CDN_BASE_URL=https://cdn.muset.ai
```

### 构建优化
```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom'],
          'editor': ['@tiptap/react', '@tiptap/starter-kit'],
          'ui': ['@radix-ui/react-dialog', '@radix-ui/react-dropdown-menu'],
        },
      },
    },
  },
});
```
